---
description: When you need to understand the project details
alwaysApply: false
---
## 3. 关键业务逻辑与数据流

### 数据流 (单向)
数据流严格在 `server` 模块内部单向流动并最终落盘：

1.  **数据采集 (`PowerUtil.java`)**:
    *   作为数据的唯一来源。
    *   直接从 `/sys/class/power_supply/battery/` 目录下的文件中读取原始、未经处理的电池数据（如电压、电流）。
    *   此操作需要高权限。

2.  **数据调度 (`Server.java`)**:
    *   作为 `server` 模块的大脑。
    *   根据配置的采样频率，周期性地调用 `PowerUtil` 来获取数据。

3.  **数据存储 (`PowerDataStorage.java`)**:
    *   作为数据的唯一出口。
    *   从 `Server.java` 接收数据。
    *   **批量写入**: 将数据缓存起来，达到一定数量后一次性写入文件，以减少 I/O 开销。
    *   **分段存储**: 根据电池的充电/放电状态，将数据写入到不同的文件中，便于后续分析。

### 控制流 (`app` -> `server`)
控制流由 `app` 发起，通过 AIDL 调用 `server` 的方法：

1.  **通信建立 (`BinderProvider.kt`)**:
    *   `server` 进程启动后，会检测 `app` 进程是否在前台。
    *   一旦检测到，`server` 会主动通过 `ContentProvider` 机制，将自身的 Binder "推送"给 `app`。

2.  **配置变更 (`SettingsFragment.kt` -> `Server.java`)**:
    *   用户在 `app` 的设置界面修改了配置（如采样间隔）。
    *   配置被写入 `SharedPreferences`。
    *   `app` 通过 AIDL 调用 `server` 的 `refreshConfig()` 方法。
    *   `Server.java` 收到调用后，重新从 `SharedPreferences` 加载配置。

3.  **服务停止 (`MainActivity.kt` -> `Server.java`)**:
    *   用户在 `app` 点击停止按钮。
    *   `app` 通过 AIDL 调用 `server` 的 `stopService()` 方法，`server` 进程退出。

---

## 4. 开发注意事项与约束条件 (必须遵守)

1.  **权限**: `server` 模块必须在 `root` 或 `shell` 权限下运行，否则无法工作。
2.  **逻辑分离**: 所有核心业务逻辑（数据采集、处理、存储）**必须**在 `server` 模块中实现。
3.  **`app` 角色**: `app` 模块**严格**作为 UI 和配置控制器，**禁止**包含任何数据处理或文件读写逻辑。
4.  **通信接口**: 模块间的任何新功能或数据交换，**必须**通过扩展现有的 `IService.aidl` 接口来实现。
5.  **数据格式**: 数据存储格式（分段、批量写入）**必须**保持一致，任何修改都需在 `PowerDataStorage.java` 中统一进行。
6.  **配置管理**: 配置由 `app` 修改，存储在 `SharedPreferences` 中，`server` 仅负责读取和响应 `refreshConfig()` 调用来重新加载。

---

## 5. 编码规范与最佳实践

*   **单一职责原则**:
    *   所有文件 I/O 操作应封装在 `PowerDataStorage.java` 中。
    *   所有与系统底层硬件 API (`/sys/`) 的交互应封装在 `PowerUtil.java` 中。
*   **接口清晰**: 保持 AIDL 接口的简洁和明确，只暴露必要的控制方法。
*   **逻辑分离**: 严格分离 UI 交互逻辑 (`app`) 和后台服务逻辑 (`server`)，避免耦合。